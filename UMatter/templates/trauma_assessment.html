{% extends 'base.html' %}
{% load static %}

{% block title %}UMatter - Trauma Assessment{% endblock %}

{% block content %}
<div class="assessment-container">
    <h1 class="text-center mb-2">Trauma Assessment</h1>
    <p class="text-center mb-4" style="color: var(--color-text-muted);">Please answer honestly. There are no right or
        wrong answers.</p>

    <!-- Loading State -->
    <div id="loadingState" class="text-center" style="padding: 4rem 0;">
        <div class="loading" style="margin: 0 auto 1rem;"></div>
        <p style="color: var(--color-text-muted);">Loading your personalized assessment...</p>
    </div>

    <!-- Progress Bar -->
    <div class="progress-bar-container" id="progressContainer" style="display: none;">
        <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
    </div>

    <!-- Question Card (Dynamic) -->
    <div class="card question-card" id="questionCard" style="display: none;">
        <span class="mb-2" style="color: var(--color-primary); font-weight: 600; display: block;">Question <span
                id="qIndex">1</span> of <span id="qTotal">15</span></span>
        <h3 id="questionText" class="mb-4"></h3>

        <div class="likert-scale" id="optionsContainer">
            <!-- Options will be dynamically generated -->
        </div>

        <div class="mt-4" style="display: flex; justify-content: space-between;">
            <button class="btn btn-secondary" onclick="prevQuestion()" id="prevBtn" disabled>Previous</button>
            <button class="btn btn-primary" onclick="nextQuestion()" id="nextBtn">Next</button>
        </div>
    </div>

    <!-- Result Section (Hidden by default) -->
    <div class="card text-center" id="resultCard" style="display: none;">
        <div
            style="width: 80px; height: 80px; background: var(--gradient-heritage-vikas); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 2rem;">
            <svg class="icon" width="40" height="40">
                <use href="#icon-heart"></use>
            </svg>
        </div>
        <h2 class="mb-2">Your Assessment is Complete</h2>
        <p class="mb-4">Based on your responses, we've identified areas where you might need support.</p>

        <div id="resultsContainer"></div>

        <button class="btn btn-primary" onclick="window.location.href='{% url 'selfcare' %}'">View Recovery
            Plan</button>
    </div>
</div>

<script>
    let questions = [];
    let currentStep = 0;
    let responses = [];
    const optionLabels = ['A', 'B', 'C', 'D'];

    // Get CSRF token for Django
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Fetch questions from backend
    async function fetchQuestions() {
        try {
            const response = await fetch('/api/questions/');
            const data = await response.json();
            questions = data.questions;
            responses = new Array(questions.length).fill(null);

            // Hide loading, show assessment
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('questionCard').style.display = 'block';

            document.getElementById('qTotal').innerText = questions.length;
            loadQuestion();
        } catch (error) {
            console.error('Error fetching questions:', error);
            document.getElementById('loadingState').innerHTML = `
                <p style="color: var(--color-error);">Failed to load assessment. Please refresh the page.</p>
            `;
        }
    }

    function loadQuestion() {
        const q = questions[currentStep];
        document.getElementById('questionText').innerText = q.text;
        document.getElementById('qIndex').innerText = currentStep + 1;

        // Generate option buttons
        const optionsContainer = document.getElementById('optionsContainer');
        optionsContainer.innerHTML = '';

        q.options.forEach((option, index) => {
            const optionDiv = document.createElement('label');
            optionDiv.className = 'likert-option';
            optionDiv.innerHTML = `
                <input type="radio" name="answer" value="${optionLabels[index]}" hidden>
                <div class="likert-btn ${responses[currentStep] === optionLabels[index] ? 'selected' : ''}" 
                     onclick="selectOption(this, '${optionLabels[index]}')">${option}</div>
            `;
            optionsContainer.appendChild(optionDiv);
        });

        updateProgress();
    }

    function updateProgress() {
        const progress = ((currentStep + 1) / questions.length) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('prevBtn').disabled = currentStep === 0;
        document.getElementById('nextBtn').innerText = currentStep === questions.length - 1 ? 'Finish' : 'Next';
    }

    function selectOption(el, value) {
        document.querySelectorAll('.likert-btn').forEach(btn => btn.classList.remove('selected'));
        el.classList.add('selected');
        responses[currentStep] = value;
    }

    function nextQuestion() {
        if (responses[currentStep] === null) {
            alert('Please select an answer before continuing.');
            return;
        }

        if (currentStep < questions.length - 1) {
            currentStep++;
            loadQuestion();
        } else {
            submitAssessment();
        }
    }

    function prevQuestion() {
        if (currentStep > 0) {
            currentStep--;
            loadQuestion();
        }
    }

    async function submitAssessment() {
        // Show loading
        document.getElementById('questionCard').innerHTML = `
            <div class="text-center" style="padding: 2rem;">
                <div class="loading" style="margin: 0 auto 1rem;"></div>
                <p style="color: var(--color-text-muted);">Analyzing your responses...</p>
            </div>
        `;

        // Prepare payload
        const payload = {
            responses: questions.map((q, i) => ({
                id: q.id,
                answer: responses[i]
            }))
        };

        try {
            const response = await fetch('/api/evaluate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            displayResults(data);
        } catch (error) {
            console.error('Error submitting assessment:', error);
            document.getElementById('questionCard').innerHTML = `
                <p style="color: var(--color-error);">Failed to process assessment. Please try again.</p>
            `;
        }
    }

    function displayResults(data) {
        const categoryNames = {
            Family: 'Family Trauma',
            Financial: 'Financial Stress',
            Career: 'Career Anxiety',
            Love: 'Relationship Trauma'
        };

        const recommendations = {
            Family: `<strong>Understanding Family Trauma:</strong> Family trauma occurs when family members experience distressing events such as abuse, neglect, loss, or harmful circumstances that create emotional or physical distress. This can include domestic violence, emotional neglect, divorce, death of a family member, or intergenerational trauma patterns.<br><br>
            <strong>Common Impacts:</strong> Difficulty trusting others, attachment issues, emotional dysregulation, anxiety, depression, and challenges in forming healthy relationships.<br><br>
            <strong>Healing Steps:</strong> Consider family therapy or setting healthy boundaries with family members. Practice self-compassion and remember that healing takes time. Focus on building a support network outside your family unit and explore trauma-informed therapy approaches.`,

            Financial: `<strong>Understanding Financial Trauma:</strong> Financial trauma refers to the emotional and psychological distress from chronic money-related stress, lack of resources, or financial abuse. It goes beyond stressâ€”it's the lasting impact of financial hardship, including intergenerational poverty, sudden job loss, bankruptcy, or financial abuse in relationships.<br><br>
            <strong>Common Impacts:</strong> Symptoms mirror PTSD including sleep disturbances, excessive worrying about money, anxiety, depression, muscle tension, and sometimes obsessive-compulsive behaviors around finances.<br><br>
            <strong>Healing Steps:</strong> Start with small budgeting steps and seek free financial counseling. Remember that your worth is not defined by your finances. Practice mindful spending, track expenses for awareness, and join financial wellness support groups. Address the emotional aspects through therapy while building practical financial skills.`,

            Career: `<strong>Understanding Career Trauma:</strong> Career trauma (workplace trauma or workplace PTSD) is an emotional response to negative workplace events. This can result from unfair termination, workplace bullying, harassment, discrimination, violence, toxic work environments, ethical dilemmas, or excessive workload and unrealistic expectations.<br><br>
            <strong>Common Impacts:</strong> Increased absenteeism, difficulty concentrating, task avoidance, loss of motivation, irritability with colleagues, professional relationship challenges, and anxiety about work-related situations.<br><br>
            <strong>Healing Steps:</strong> Explore work-life balance strategies and consider career counseling. Your well-being is more important than any job. Set firm boundaries between work and personal time, practice stress-reduction techniques, and don't hesitate to seek new opportunities if your current environment is toxic. Consider therapy to process workplace experiences.`,

            Love: `<strong>Understanding Relationship Trauma:</strong> Relationship trauma occurs when fundamental needs for connection, safety, and trust are violated within relationships. This includes betrayal trauma (infidelity, deception), emotional neglect, narcissistic abuse (manipulation, gaslighting), and physical or sexual trauma. These experiences leave deep emotional scars affecting future relationship capacity.<br><br>
            <strong>Common Impacts:</strong> Difficulty trusting partners, hypervigilance, avoiding intimacy, feeling defensive or easily triggered, emotional disconnection, flashbacks, and diminished self-worth.<br><br>
            <strong>Healing Steps:</strong> Focus on building trust gradually and consider relationship or individual counseling. Practice self-love and healthy communication skills. Learn to recognize red flags, establish clear boundaries, and prioritize your emotional safety. Remember that healing is possible and you deserve healthy, respectful relationships.`
        };

        // Sort predictions by probability
        const sortedPredictions = Object.entries(data.prediction).sort((a, b) => b[1] - a[1]);
        const primary = sortedPredictions[0];
        const secondary = sortedPredictions[1];

        let resultsHTML = `
            <div style="background: var(--color-surface); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; text-align: left; border-left: 4px solid var(--color-primary);">
                <h4 style="color: var(--color-primary);">Primary Focus: ${categoryNames[primary[0]]}</h4>
                <p style="margin-bottom: 0.5rem;"><strong>Confidence:</strong> ${(primary[1] * 100).toFixed(1)}%</p>
                <p style="margin-bottom: 0.5rem;"><strong>Average Score:</strong> ${data.features[primary[0]].toFixed(2)} / 3.0</p>
                <p>${recommendations[primary[0]]}</p>
            </div>
        `;

        if (secondary[1] > 0.2) {
            resultsHTML += `
                <div style="background: rgba(255, 153, 51, 0.05); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 2rem; text-align: left; border-left: 4px solid var(--color-secondary);">
                    <h4 style="color: var(--color-secondary);">Secondary Focus: ${categoryNames[secondary[0]]}</h4>
                    <p style="margin-bottom: 0.5rem;"><strong>Confidence:</strong> ${(secondary[1] * 100).toFixed(1)}%</p>
                    <p style="margin-bottom: 0.5rem;"><strong>Average Score:</strong> ${data.features[secondary[0]].toFixed(2)} / 3.0</p>
                    <p>${recommendations[secondary[0]]}</p>
                </div>
            `;
        }

        document.getElementById('resultsContainer').innerHTML = resultsHTML;
        document.getElementById('questionCard').style.display = 'none';
        document.getElementById('resultCard').style.display = 'block';
        document.getElementById('progressContainer').style.display = 'none';
    }

    // Initialize on load
    fetchQuestions();
</script>
{% endblock %}