{% extends 'base.html' %}
{% load static %}

{% block title %}UMatter - Progress{% endblock %}

{% block content %}
<div class="container" style="padding: 4rem 1.5rem;">
    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
        <h1>Your Journey</h1>
        <div class="card" style="padding: 0.75rem 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <svg class="icon" width="20" height="20" style="color: var(--color-warning);">
                <use href="#icon-zap"></use>
            </svg>
            <span style="font-weight: 600;" id="streakText">Loading streak...</span>
        </div>
    </div>

    <!-- Mood Tracker -->
    <div class="card mb-5 text-center">
        <h3>How are you feeling today?</h3>
        <div class="mood-tracker">
            <button class="mood-btn" data-mood="1" onclick="selectMood(1, 'üò¢')">üò¢</button>
            <button class="mood-btn" data-mood="2" onclick="selectMood(2, 'üòï')">üòï</button>
            <button class="mood-btn" data-mood="3" onclick="selectMood(3, 'üòê')">üòê</button>
            <button class="mood-btn" data-mood="4" onclick="selectMood(4, 'üôÇ')">üôÇ</button>
            <button class="mood-btn" data-mood="5" onclick="selectMood(5, 'üòÅ')">üòÅ</button>
        </div>
        <p id="moodText" style="color: var(--color-text-muted); margin-top: 1rem;">Select a mood to check in.</p>

        <!-- Optional Notes -->
        <div id="moodNotesSection" style="display: none; margin-top: 1.5rem;">
            <textarea id="moodNotes" placeholder="How are you feeling? (optional)"
                style="width: 100%; max-width: 500px; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-family: inherit; resize: vertical;"
                rows="3"></textarea>
            <button class="btn btn-primary mt-3" onclick="saveMood()">Save Mood Entry</button>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="features-grid">
        <!-- Weekly Mood Chart -->
        <div class="card" style="grid-column: span 2;">
            <h4 class="mb-3">Weekly Mood Trend</h4>
            <canvas id="moodChart" style="max-height: 300px;"></canvas>
            <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                <button class="btn btn-secondary btn-sm" onclick="loadMoodData(7)">7 Days</button>
                <button class="btn btn-primary btn-sm" onclick="loadMoodData(14)">14 Days</button>
                <button class="btn btn-secondary btn-sm" onclick="loadMoodData(30)">30 Days</button>
            </div>
        </div>

        <!-- Mood Statistics -->
        <div class="card">
            <h4 class="mb-3">Mood Statistics</h4>
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--color-text-muted);">Average This Week</span>
                        <span id="avgMood"
                            style="font-size: 2rem; font-weight: 600; color: var(--color-primary);">-</span>
                    </div>
                </div>
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--color-text-muted);">Trend</span>
                        <span id="trendIndicator" style="font-weight: 600;">-</span>
                    </div>
                </div>
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--color-text-muted);">Best Day</span>
                        <span id="bestDay" style="font-weight: 600; color: var(--color-success);">-</span>
                    </div>
                </div>
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--color-text-muted);">Entries Logged</span>
                        <span id="totalEntries" style="font-weight: 600; color: var(--color-primary);">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts & Insights -->
        <div class="card">
            <h4 class="mb-3">Insights & Alerts</h4>
            <div id="alertsContainer" style="display: flex; flex-direction: column; gap: 1rem;">
                <p style="color: var(--color-text-muted); font-style: italic;">Loading insights...</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Authentication check
    {% if not user.is_authenticated %}
    alert('Please login to view your progress tracker.');
    window.location.href = '{% url "accounts:login" %}?next={{ request.path }}';
    {% endif %}

    let selectedMoodValue = null;
    let moodChart = null;
    // Actual logged-in user ID

    // CSRF Token for POST requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function selectMood(value, emoji) {
        selectedMoodValue = value;
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`[data-mood="${value}"]`).classList.add('active');

        const moodLabels = {
            1: 'Very Sad',
            2: 'Sad',
            3: 'Neutral',
            4: 'Happy',
            5: 'Very Happy'
        };

        document.getElementById('moodText').innerText = `You selected: ${moodLabels[value]} ${emoji}`;
        document.getElementById('moodText').style.color = "var(--color-primary)";
        document.getElementById('moodNotesSection').style.display = 'block';
    }

    async function saveMood() {
        if (!selectedMoodValue) {
            alert('Please select a mood first');
            return;
        }

        const notes = document.getElementById('moodNotes').value;

        try {
            const response = await fetch('/api/v1/mood/log/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    user_id: userId,
                    mood_level: selectedMoodValue,
                    notes: notes
                })
            });

            if (response.ok) {
                document.getElementById('moodText').innerText = "‚úÖ Mood logged successfully!";
                document.getElementById('moodText').style.color = "var(--color-success)";
                document.getElementById('moodNotes').value = '';
                document.getElementById('moodNotesSection').style.display = 'none';

                // Reset mood selection
                document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
                selectedMoodValue = null;

                // Reload data
                loadMoodData(14);
                loadAlerts();
            } else {
                const error = await response.json();
                alert('Error saving mood: ' + (error.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error saving mood:', error);
            alert('Failed to save mood. Please try again.');
        }
    }

    async function loadMoodData(days = 14) {
        try {
            const response = await fetch(`/api/v1/mood/history/?user_id=${userId}&days=${days}`);
            const data = await response.json();

            if (data.history && data.history.length > 0) {
                updateChart(data.history);
                updateStatistics(data.history);
            } else {
                // Show empty state
                if (moodChart) {
                    moodChart.data.labels = [];
                    moodChart.data.datasets[0].data = [];
                    moodChart.update();
                }
                document.getElementById('avgMood').innerText = '-';
                document.getElementById('trendIndicator').innerText = 'No data yet';
                document.getElementById('bestDay').innerText = '-';
                document.getElementById('totalEntries').innerText = '0';
            }

            // Update active button
            document.querySelectorAll('.btn-sm').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            event.target.classList.remove('btn-secondary');
            event.target.classList.add('btn-primary');
        } catch (error) {
            console.error('Error loading mood data:', error);
        }
    }

    function updateChart(history) {
        const labels = history.map(entry => {
            const date = new Date(entry.logged_at);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        const data = history.map(entry => entry.mood_level);

        const ctx = document.getElementById('moodChart').getContext('2d');

        if (moodChart) {
            moodChart.data.labels = labels;
            moodChart.data.datasets[0].data = data;
            moodChart.update();
        } else {
            moodChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Mood Level',
                        data: data,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5,
                            ticks: {
                                stepSize: 1,
                                callback: function (value) {
                                    const labels = ['', 'üò¢', 'üòï', 'üòê', 'üôÇ', 'üòÅ'];
                                    return labels[value] || value;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const moodLabels = ['', 'Very Sad', 'Sad', 'Neutral', 'Happy', 'Very Happy'];
                                    return moodLabels[context.parsed.y] || context.parsed.y;
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    function updateStatistics(history) {
        // Calculate average mood
        const sum = history.reduce((acc, entry) => acc + entry.mood_level, 0);
        const avg = (sum / history.length).toFixed(1);
        document.getElementById('avgMood').innerText = avg;

        // Calculate trend
        if (history.length >= 2) {
            const recent = history.slice(-3).reduce((acc, e) => acc + e.mood_level, 0) / Math.min(3, history.length);
            const older = history.slice(0, 3).reduce((acc, e) => acc + e.mood_level, 0) / Math.min(3, history.length);

            if (recent > older + 0.5) {
                document.getElementById('trendIndicator').innerHTML = 'üìà Improving';
                document.getElementById('trendIndicator').style.color = 'var(--color-success)';
            } else if (recent < older - 0.5) {
                document.getElementById('trendIndicator').innerHTML = 'üìâ Declining';
                document.getElementById('trendIndicator').style.color = 'var(--color-error)';
            } else {
                document.getElementById('trendIndicator').innerHTML = '‚û°Ô∏è Stable';
                document.getElementById('trendIndicator').style.color = 'var(--color-text-muted)';
            }
        }

        // Find best day
        const bestEntry = history.reduce((max, entry) => entry.mood_level > max.mood_level ? entry : max, history[0]);
        const bestDate = new Date(bestEntry.logged_at);
        document.getElementById('bestDay').innerText = bestDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        // Total entries
        document.getElementById('totalEntries').innerText = history.length;

        // Calculate streak
        let streak = 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let i = history.length - 1; i >= 0; i--) {
            const entryDate = new Date(history[i].logged_at);
            entryDate.setHours(0, 0, 0, 0);
            const daysDiff = Math.floor((today - entryDate) / (1000 * 60 * 60 * 24));

            if (daysDiff === streak) {
                streak++;
            } else {
                break;
            }
        }

        document.getElementById('streakText').innerText = `${streak} Day Streak!`;
    }

    async function loadAlerts() {
        try {
            const response = await fetch(`/api/v1/alerts/?user_id=${userId}`);
            const data = await response.json();

            const container = document.getElementById('alertsContainer');

            if (data.alerts && data.alerts.length > 0) {
                container.innerHTML = data.alerts.map(alert => `
                    <div style="padding: 1rem; background: ${alert.severity === 'high' ? 'rgba(244, 67, 54, 0.1)' : 'rgba(255, 193, 7, 0.1)'}; border-left: 3px solid ${alert.severity === 'high' ? 'var(--color-error)' : 'var(--color-warning)'}; border-radius: var(--radius-sm);">
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${alert.title}</div>
                        <div style="font-size: 0.9rem; color: var(--color-text-muted);">${alert.message}</div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p style="color: var(--color-success); font-style: italic;">‚ú® All good! Keep up the great work.</p>';
            }
        } catch (error) {
            console.error('Error loading alerts:', error);
        }
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
        loadMoodData(14);
        loadAlerts();
    });
</script>
{% endblock %}